---
export const prerender = false;

import PostItem from "@/components/blog/PostItem.astro";
import Layout from "@/layouts/Layout.astro";
import { CategorySchema, PostsSchema } from "@/types";

// Obtener el slug de la categoría desde los parámetros de la URL
const { slug } = Astro.params;

// Obtener la categoría desde WordPress API
// Usamos cache: "no-store" para obtener datos frescos en cada request (SSR)
const catUrl = `${import.meta.env.API_URL}/categories?slug=${slug}`;
const catResponse = await fetch(catUrl, {
    cache: "no-store",
    headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
    },
});
const catJson = await catResponse.json();
const category = CategorySchema.parse(catJson[0]);

if (!category) {
    return Astro.redirect("/404");
}

// Obtener los posts de la categoría desde WordPress API
const postsUrl = `${import.meta.env.API_URL}/posts?categories=${category.id}`;
const postsResponse = await fetch(postsUrl, {
    cache: "no-store",
    headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
    },
});
const postsJson = await postsResponse.json();
const posts = PostsSchema.parse(postsJson);
---

<Layout title={`Posts en la categoría ${category.name}`}>
    {
        posts.map((post, index) => (
            <>
                <PostItem post={post} />
                {index < posts.length - 1 && (
                    <div class="my-12 flex items-center">
                        <div
                            aria-hidden="true"
                            class="w-full border-t border-zinc-300/20"
                        />
                        <div class="relative flex justify-center">
                            <span class="bg-slate-900 px-2 text-sm text-zinc-500">
                                Continue
                            </span>
                        </div>
                        <div
                            aria-hidden="true"
                            class="w-full border-t border-zinc-300/20"
                        />
                    </div>
                )}
            </>
        ))
    }
</Layout>
