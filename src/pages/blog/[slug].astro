---
import PostLayout from "@/layouts/PostLayout.astro";
import { PostItemSchema, type Post } from "@/types";
import PostMeta from "@/components/blog/PostMeta.astro";
import PostCategories from "@/components/blog/PostCategories.astro";
import { Picture } from "astro:assets";
import { createHighlighter } from "shiki";

export const prerender = false;

const { slug } = Astro.params;
const url = `${import.meta.env.API_URL}/posts?slug=${slug}`;
const response = await fetch(url, {
    cache: "no-store",
    headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        Pragma: "no-cache",
        Expires: "0",
    },
});
const json = await response.json();
const post = PostItemSchema.safeParse(json[0]);

if (!post.success) {
    return Astro.redirect("/404");
}

const { title, content, date, featured_images, post_categories } =
    post.data as Post;

// Procesar bloques de código con Shiki
const highlighter = await createHighlighter({
    themes: ["github-dark"],
    langs: [
        "javascript",
        "typescript",
        "jsx",
        "tsx",
        "cpp",
        "c",
        "php",
        "html",
        "css",
        "scss",
        "json",
        "bash",
        "shell",
        "sql",
        "markdown",
        "yaml",
        "xml",
    ],
});

// Función para procesar el contenido HTML y resaltar bloques de código
function processCodeBlocks(html: string): string {
    // Regex para encontrar bloques <pre><code class="language-xxx">...</code></pre>
    const codeBlockRegex =
        /<pre[^>]*><code[^>]*class="language-(\w+)"[^>]*>([\s\S]*?)<\/code><\/pre>/g;

    return html.replace(codeBlockRegex, (match, lang, code) => {
        // Decodificar entidades HTML
        const decodedCode = code
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&amp;/g, "&")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'");

        try {
            // Generar HTML con resaltado de sintaxis
            const highlighted = highlighter.codeToHtml(decodedCode, {
                lang: lang,
                theme: "github-dark",
            });
            return highlighted;
        } catch (error) {
            // Si el lenguaje no está soportado, intentar con 'text'
            console.warn(
                `Language '${lang}' not supported, falling back to 'text'`,
            );
            try {
                const highlighted = highlighter.codeToHtml(decodedCode, {
                    lang: "text",
                    theme: "github-dark",
                });
                return highlighted;
            } catch (fallbackError) {
                console.error(
                    `Error highlighting code for language: ${lang}`,
                    fallbackError,
                );
                return match; // Retornar el bloque original si hay error
            }
        }
    });
}

const processedContent = processCodeBlocks(content.rendered);
---

<PostLayout title={title.rendered}>
    <!-- Post Header -->
    <header class="mb-12 space-y-6">
        <h1 class="text-4xl md:text-5xl font-bold text-slate-100 leading-tight">
            {title.rendered}
        </h1>

        <PostMeta date={date} />
        <PostCategories categories={post_categories} />
    </header>

    <!-- Featured Image -->
    {
        featured_images?.full.url && (
            <Picture
                src={featured_images.full.url}
                alt={title.rendered}
                width={featured_images.full.width}
                height={featured_images.full.height}
                formats={["avif", "webp"]}
                class="w-full rounded-lg shadow-2xl mb-12"
            />
        )
    }

    <!-- Post Content -->
    <div class="post-content" set:html={processedContent} />
</PostLayout>

<style is:inline>
    /* Estilos específicos para el contenido del post */
    .post-content h2 {
        font-size: 1.875rem;
        font-weight: 600;
        color: #e2e8f0;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        letter-spacing: -0.025em;
    }

    .post-content h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #e2e8f0;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
    }

    .post-content h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #e2e8f0;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .post-content p {
        margin-bottom: 1.5rem;
        line-height: 1.8;
    }

    .post-content ul,
    .post-content ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .post-content li {
        margin-bottom: 0.5rem;
    }

    .post-content blockquote {
        border-left: 4px solid #334155;
        padding-left: 1.5rem;
        margin: 2rem 0;
        font-style: italic;
        color: #94a3b8;
    }

    .post-content img {
        border-radius: 0.5rem;
        margin: 2rem auto;
        max-width: 100%;
        height: auto;
    }

    .post-content a {
        color: #5eead4;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s;
    }

    .post-content a:hover {
        border-bottom-color: #5eead4;
    }

    /* Estilos para bloques de código renderizados por Shiki */
    .post-content pre {
        padding: 1.5rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 2rem 0;
        font-size: 0.875rem;
        line-height: 1.7;
        font-family: "Courier New", Courier, monospace;
        background: #1e293b;
        border: 1px solid #334155;
    }

    .post-content pre code {
        display: block;
        padding: 0;
        background: transparent;
        border: none;
        font-size: inherit;
        line-height: inherit;
        color: inherit;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        tab-size: 4;
    }

    /* Asegurar que los colores de Shiki se preserven */
    .post-content pre code .line {
        display: block;
        min-height: 1em;
    }

    /* Estilos para código inline */
    .post-content code:not(pre code) {
        background-color: rgba(100, 116, 139, 0.2);
        color: #5eead4;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 0.875em;
        font-family: "Courier New", Courier, monospace;
    }

    /* Scrollbar personalizado para bloques de código */
    .post-content pre::-webkit-scrollbar {
        height: 8px;
    }

    .post-content pre::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }

    .post-content pre::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
    }

    .post-content pre::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }
</style>
